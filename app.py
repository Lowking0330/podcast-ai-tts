import streamlit as st
from gradio_client import Client

# ---------------------------------------------------------
# 1. è¨­å®šèˆ‡è³‡æ–™å€
# ---------------------------------------------------------
speaker_map = {
    'è³½å¾·å…‹': ['è³½å¾·å…‹_å¾·é¹¿è°·_å¥³è²', 'è³½å¾·å…‹_éƒ½é”_å¥³è²', 'è³½å¾·å…‹_å¾·å›ºé”é›…_ç”·è²', 'è³½å¾·å…‹_å¾·å›ºé”é›…_å¥³è²'],
    'å¤ªé­¯é–£': ['å¤ªé­¯é–£_å¥³è²', 'å¤ªé­¯é–£_ç”·è²1', 'å¤ªé­¯é–£_ç”·è²2'],
    'è³½å¤': ['è³½å¤_å¥³è²'],
    'å¸ƒè¾²': ['å¸ƒè¾²_éƒ¡ç¾¤_ç”·è²', 'å¸ƒè¾²_å¡ç¾¤_ç”·è²', 'å¸ƒè¾²_å·’ç¾¤_ç”·è²', 'å¸ƒè¾²_ä¸¹ç¾¤_ç”·è²', 'å¸ƒè¾²_å“ç¾¤_å¥³è²'],
    'æ³°é›…': ['æ³°é›…_å››å­£_å¥³è²', 'æ³°é›…_è³½è€ƒåˆ©å…‹_ç”·è²', 'æ³°é›…_è¬å¤§_å¥³è²', 'æ³°é›…_æ±¶æ°´_ç”·è²', 'æ³°é›…_å®œè˜­æ¾¤æ•–åˆ©_å¥³è²', 'æ³°é›…_æ¾¤æ•–åˆ©_ç”·è²'],
    'é„’': ['é„’_å¥³è²'],
    'é­¯å‡±': ['é­¯å‡±_å¤§æ­¦_å¥³è²', 'é­¯å‡±_å¤šç´_ç”·è²', 'é­¯å‡±_æ±_å¥³è²', 'é­¯å‡±_èŒ‚æ—_ç”·è²', 'é­¯å‡±_è¬å±±_å¥³è²', 'é­¯å‡±_éœ§å°_å¥³è²'],
    'æ’ç£': ['æ’ç£_ä¸­_ç”·è²', 'æ’ç£_æ±_ç”·è²', 'æ’ç£_åŒ—_å¥³è²', 'æ’ç£_å—_å¥³è²'],
    'é›…ç¾': ['é›…ç¾_å¥³è²'],
    'å‘å—': ['å‘å—_å»ºå’Œ_å¥³è²', 'å‘å—_å—ç‹_å¥³è²', 'å‘å—_è¥¿ç¾¤_å¥³è²', 'å‘å—_çŸ¥æœ¬_å¥³è²'],
    'é‚µ': ['é‚µ_ç”·è²'],
    'å™¶ç‘ªè˜­': ['å™¶ç‘ªè˜­_å¥³è²'],
    'æ‹‰é˜¿é­¯å“‡': ['æ‹‰é˜¿é­¯å“‡_å¥³è²'],
    'æ’’å¥‡èŠé›…': ['æ’’å¥‡èŠé›…_å¥³è²'],
    'å¡é‚£å¡é‚£å¯Œ': ['å¡é‚£å¡é‚£å¯Œ_ç”·è²'],
    'é˜¿ç¾': ['é˜¿ç¾_æµ·å²¸_ç”·è²', 'é˜¿ç¾_æ†æ˜¥_å¥³è²', 'é˜¿ç¾_é¦¬è˜­_å¥³è²', 'é˜¿ç¾_å—å‹¢_å¥³è²', 'é˜¿ç¾_ç§€å§‘å·’_å¥³è²1', 'é˜¿ç¾_ç§€å§‘å·’_å¥³è²2'],
}

# ---------------------------------------------------------
# 2. è¼”åŠ©å‡½å¼ï¼šæš´åŠ›ç ´è§£é©—è­‰æ¸…å–®
# ---------------------------------------------------------
def force_add_speaker_to_client(client_obj, new_speaker):
    """
    éè¿´æœå°‹ Client ç‰©ä»¶ä¸­çš„æ‰€æœ‰è¨­å®šï¼Œ
    æ‰¾åˆ°åŸæœ¬åªåŒ…å« 'é˜¿ç¾_æµ·å²¸_ç”·è²' çš„æ¸…å–®ï¼Œä¸¦å¼·åˆ¶åŠ å…¥æ–°èªè€…ã€‚
    """
    target_marker = 'é˜¿ç¾_æµ·å²¸_ç”·è²' # ç”¨é€™å€‹ç•¶ä½œç‰¹å¾µä¾†æ‰¾æ¸…å–®
    
    # å…§éƒ¨éè¿´å‡½å¼
    def recursive_search(obj):
        if isinstance(obj, dict):
            for k, v in obj.items():
                # å¦‚æœæ‰¾åˆ° 'choices' ä¸”è£¡é¢æœ‰é˜¿ç¾æ—ï¼Œé€™å°±æ˜¯æˆ‘å€‘è¦æ”¹çš„æ¸…å–®ï¼
                if k == 'choices' and isinstance(v, list) and target_marker in v:
                    if new_speaker not in v:
                        v.append(new_speaker)
                        print(f"ğŸ”§ æˆåŠŸè§£é–èªè€…ï¼š{new_speaker}")
                else:
                    recursive_search(v)
        elif isinstance(obj, (list, tuple)):
            for item in obj:
                recursive_search(item)
                
    # 1. æœå°‹ endpoints è¨­å®š
    if hasattr(client_obj, 'endpoints'):
        recursive_search(client_obj.endpoints)
    
    # 2. æœå°‹ config è¨­å®š (é›™é‡ä¿éšª)
    if hasattr(client_obj, 'config'):
        recursive_search(client_obj.config)

# ---------------------------------------------------------
# 3. ä»‹é¢è¨­è¨ˆå€
# ---------------------------------------------------------
st.title("è‡ºç£åŸä½æ°‘æ—èª Podcast ç”Ÿæˆå™¨ ğŸ™ï¸")
st.markdown("æ”¯æ´ 16 æ— 42 ç¨®èªéŸ³åˆæˆ")

col1, col2 = st.columns(2)

with col1:
    selected_tribe = st.selectbox("æ­¥é©Ÿ 1ï¼šé¸æ“‡æ—ç¾¤", list(speaker_map.keys()), index=15)

with col2:
    available_speakers = speaker_map[selected_tribe]
    selected_speaker = st.selectbox("æ­¥é©Ÿ 2ï¼šé¸æ“‡èªè€…", available_speakers)

text_input = st.text_area("æ­¥é©Ÿ 3ï¼šè¼¸å…¥è¦åˆæˆçš„æ–‡å­—", height=150, placeholder="è«‹è¼¸å…¥æ—èªæ–‡å­—...")

# ---------------------------------------------------------
# 4. æ ¸å¿ƒé‚è¼¯å€
# ---------------------------------------------------------
if st.button("é–‹å§‹ç”ŸæˆèªéŸ³", type="primary"):
    if not text_input:
        st.warning("è«‹å…ˆè¼¸å…¥æ–‡å­—ï¼")
    else:
        try:
            with st.spinner(f"æ­£åœ¨é€£ç·šä¸¦ç”Ÿæˆ {selected_speaker} çš„è²éŸ³..."):
                
                # åˆå§‹åŒ– Client
                client = Client("https://hnang-kari-ai-asi-sluhay.ithuan.tw/")
                
                # ğŸ”¥ åŸ·è¡Œæš´åŠ›è§£é– (ä¸ä¾è³´ç‰¹å®šå±¬æ€§åç¨±ï¼Œåªè¦æœ‰æ¸…å–®å°±æ”¹)
                force_add_speaker_to_client(client, selected_speaker)

                # æ­£å¼ç”ŸæˆèªéŸ³
                result = client.predict(
                    ref=selected_speaker,       
                    gen_text_input=text_input,  
                    api_name="/default_speaker_tts"
                )
                
                st.success("ç”ŸæˆæˆåŠŸï¼")
                st.audio(result)
                
        except Exception as e:
            st.error(f"ç”Ÿæˆå¤±æ•—ï¼š{e}")
            st.expander("æŸ¥çœ‹è©³ç´°éŒ¯èª¤æ—¥èªŒ").write(str(e))
