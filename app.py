import streamlit as st
from gradio_client import Client

# ---------------------------------------------------------
# 1. è¨­å®šèˆ‡è³‡æ–™å€
# ---------------------------------------------------------
speaker_map = {
    'è³½å¾·å…‹': ['è³½å¾·å…‹_å¾·é¹¿è°·_å¥³è²', 'è³½å¾·å…‹_éƒ½é”_å¥³è²', 'è³½å¾·å…‹_å¾·å›ºé”é›…_ç”·è²', 'è³½å¾·å…‹_å¾·å›ºé”é›…_å¥³è²'],
    'å¤ªé­¯é–£': ['å¤ªé­¯é–£_å¥³è²', 'å¤ªé­¯é–£_ç”·è²1', 'å¤ªé­¯é–£_ç”·è²2'],
    'è³½å¤': ['è³½å¤_å¥³è²'],
    'å¸ƒè¾²': ['å¸ƒè¾²_éƒ¡ç¾¤_ç”·è²', 'å¸ƒè¾²_å¡ç¾¤_ç”·è²', 'å¸ƒè¾²_å·’ç¾¤_ç”·è²', 'å¸ƒè¾²_ä¸¹ç¾¤_ç”·è²', 'å¸ƒè¾²_å“ç¾¤_å¥³è²'],
    'æ³°é›…': ['æ³°é›…_å››å­£_å¥³è²', 'æ³°é›…_è³½è€ƒåˆ©å…‹_ç”·è²', 'æ³°é›…_è¬å¤§_å¥³è²', 'æ³°é›…_æ±¶æ°´_ç”·è²', 'æ³°é›…_å®œè˜­æ¾¤æ•–åˆ©_å¥³è²', 'æ³°é›…_æ¾¤æ•–åˆ©_ç”·è²'],
    'é„’': ['é„’_å¥³è²'],
    'é­¯å‡±': ['é­¯å‡±_å¤§æ­¦_å¥³è²', 'é­¯å‡±_å¤šç´_ç”·è²', 'é­¯å‡±_æ±_å¥³è²', 'é­¯å‡±_èŒ‚æ—_ç”·è²', 'é­¯å‡±_è¬å±±_å¥³è²', 'é­¯å‡±_éœ§å°_å¥³è²'],
    'æ’ç£': ['æ’ç£_ä¸­_ç”·è²', 'æ’ç£_æ±_ç”·è²', 'æ’ç£_åŒ—_å¥³è²', 'æ’ç£_å—_å¥³è²'],
    'é›…ç¾': ['é›…ç¾_å¥³è²'],
    'å‘å—': ['å‘å—_å»ºå’Œ_å¥³è²', 'å‘å—_å—ç‹_å¥³è²', 'å‘å—_è¥¿ç¾¤_å¥³è²', 'å‘å—_çŸ¥æœ¬_å¥³è²'],
    'é‚µ': ['é‚µ_ç”·è²'],
    'å™¶ç‘ªè˜­': ['å™¶ç‘ªè˜­_å¥³è²'],
    'æ‹‰é˜¿é­¯å“‡': ['æ‹‰é˜¿é­¯å“‡_å¥³è²'],
    'æ’’å¥‡èŠé›…': ['æ’’å¥‡èŠé›…_å¥³è²'],
    'å¡é‚£å¡é‚£å¯Œ': ['å¡é‚£å¡é‚£å¯Œ_ç”·è²'],
    'é˜¿ç¾': ['é˜¿ç¾_æµ·å²¸_ç”·è²', 'é˜¿ç¾_æ†æ˜¥_å¥³è²', 'é˜¿ç¾_é¦¬è˜­_å¥³è²', 'é˜¿ç¾_å—å‹¢_å¥³è²', 'é˜¿ç¾_ç§€å§‘å·’_å¥³è²1', 'é˜¿ç¾_ç§€å§‘å·’_å¥³è²2'],
}

# ---------------------------------------------------------
# 2. ä»‹é¢è¨­è¨ˆå€
# ---------------------------------------------------------
st.title("è‡ºç£åŸä½æ°‘æ—èª Podcast ç”Ÿæˆå™¨ ğŸ™ï¸")
st.markdown("æ”¯æ´ 16 æ— 42 ç¨®èªéŸ³åˆæˆ")

col1, col2 = st.columns(2)

with col1:
    selected_tribe = st.selectbox("æ­¥é©Ÿ 1ï¼šé¸æ“‡æ—ç¾¤", list(speaker_map.keys()), index=15) # é è¨­é¸é˜¿ç¾(é¿å…ç©ºå€¼)

with col2:
    available_speakers = speaker_map[selected_tribe]
    selected_speaker = st.selectbox("æ­¥é©Ÿ 2ï¼šé¸æ“‡èªè€…", available_speakers)

text_input = st.text_area("æ­¥é©Ÿ 3ï¼šè¼¸å…¥è¦åˆæˆçš„æ–‡å­—", height=150, placeholder="è«‹è¼¸å…¥æ—èªæ–‡å­—...")

# ---------------------------------------------------------
# 3. æ ¸å¿ƒé‚è¼¯å€ (åŒ…å«éŒ¯èª¤ä¿®æ­£ Hack)
# ---------------------------------------------------------
if st.button("é–‹å§‹ç”ŸæˆèªéŸ³", type="primary"):
    if not text_input:
        st.warning("è«‹å…ˆè¼¸å…¥æ–‡å­—ï¼")
    else:
        try:
            with st.spinner(f"æ­£åœ¨é€£ç·šä¸¦ç”Ÿæˆ {selected_speaker} çš„è²éŸ³..."):
                
                # A. å»ºç«‹é€£ç·š
                client = Client("https://hnang-kari-ai-asi-sluhay.ithuan.tw/")
                
                # ==========================================================
                # ğŸ”§ é—œéµä¿®æ­£ï¼šç¹éå®¢æˆ¶ç«¯é©—è­‰ (Client-side Validation Bypass)
                # ==========================================================
                # åŸå› ï¼šAPI é è¨­åªèªè­˜é˜¿ç¾æ—ï¼Œæˆ‘å€‘å¿…é ˆæ‰‹å‹•æŠŠã€Œé¸å®šçš„èªè€…ã€å¡é€²å®ƒçš„ç™½åå–®
                # æ‰¾åˆ° /default_speaker_tts ç«¯é»çš„è¨­å®š
                for endpoint in client.endpoints.values():
                    if endpoint.api_name == "/default_speaker_tts":
                        # æ‰¾åˆ°ç¬¬ä¸€å€‹åƒæ•¸ (ref)ï¼Œå®ƒé€šå¸¸æ˜¯ä¸€å€‹ Dropdown
                        for param in endpoint.parameters:
                            if "enum" in param:
                                # é€™è£¡å°±æ˜¯ API èªç‚ºåˆæ³•çš„æ¸…å–®ï¼Œæˆ‘å€‘å¼·åˆ¶æŠŠå®ƒæ“´å……
                                # é€™æ¨£ Client å°±ä¸æœƒå ±éŒ¯èªª "Value is not in choices"
                                if selected_speaker not in param["enum"]:
                                    param["enum"].append(selected_speaker)
                # ==========================================================

                # B. (é¸ç”¨) å…ˆé€šçŸ¥ Server åˆ‡æ›æ—ç¾¤
                # é›–ç„¶æˆ‘å€‘ç¹éäº†é©—è­‰ï¼Œä½†æœ€å¥½é‚„æ˜¯ç¦®è²Œæ€§å‘¼å«ä¸€ä¸‹åˆ‡æ›æ—ç¾¤çš„ API
                # é€™æ¨£ Server ç«¯å¦‚æœæœ‰è¼‰å…¥æ¨¡å‹çš„å‹•ä½œæ‰ä¸æœƒå‡ºéŒ¯
                try:
                    client.predict(ethnicity=selected_tribe, api_name="/lambda")
                except:
                    pass # é€™ä¸€ä¸é‡è¦ï¼Œå¤±æ•—ä¹Ÿæ²’é—œä¿‚ï¼Œé‡é»æ˜¯ä¸‹é¢é‚£è¡Œ

                # C. æ­£å¼ç”ŸæˆèªéŸ³
                result = client.predict(
                    ref=selected_speaker,       # èªè€… ID
                    gen_text_input=text_input,  # è¼¸å…¥æ–‡å­—
                    api_name="/default_speaker_tts"
                )
                
                st.success("ç”ŸæˆæˆåŠŸï¼")
                st.audio(result)
                
        except Exception as e:
            st.error(f"ç”Ÿæˆå¤±æ•—ï¼š{e}")
            # å±•é–‹è©³ç´°éŒ¯èª¤è³‡è¨Šä»¥ä¾¿é™¤éŒ¯
            st.expander("æŸ¥çœ‹è©³ç´°éŒ¯èª¤æ—¥èªŒ").write(str(e))
